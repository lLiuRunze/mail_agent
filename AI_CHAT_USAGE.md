# AI 交互界面使用指南

## 功能概述

前端 AI 交互界面已成功接入后端的自然语言处理引擎。用户可以在输入框中输入自然语言指令，系统将自动：
1. 通过 NLU 引擎识别用户意图
2. 提取相关参数
3. 执行对应的邮件操作
4. 返回结构化的执行结果

## 接口流程

```
用户输入 → 前端 sendMessage() 
         → POST /api/chat 
         → NLU 解析意图
         → TaskExecutor 执行任务
         → 返回结果 
         → 前端展示结果
```

## 支持的指令类型

### 1. 查询类指令
- "查看最近10封邮件"
- "列出今天的邮件"
- "显示未读邮件"
- "查找发件人是张三的邮件"

### 2. 搜索类指令
- "搜索标题包含账单的邮件"
- "查找包含发票的邮件"
- "搜索来自support@example.com的邮件"

### 3. 单封邮件操作
- "回复第一封邮件：好的，我知道了"
- "转发邮件123给李四"
- "归档邮件456"
- "删除这封邮件"
- "标记邮件789为已读"
- "标记为未读"

### 4. 批量操作
- "归档所有已读邮件"
- "删除所有垃圾邮件"
- "批量转发给团队成员"
- "标记所有为已读"

### 5. AI 功能
- "总结最近的邮件"
- "总结邮件123的内容"
- "分析邮件优先级"
- "帮我生成一封回复"

### 6. 撰写邮件
- "发送邮件给张三，标题是会议通知，内容是明天下午3点开会"
- "写一封邮件给support@example.com询问订单状态"

## 前端实现细节

### AssistantPanel 组件
- **位置**: `frontend/src/components/AssistantPanel.tsx`
- **功能**:
  - 显示聊天消息历史
  - 接收用户输入
  - 调用 `onSendMessage` 回调
  - 展示意图标签和执行结果

### 结果展示功能
`renderResult()` 函数会智能展示：
- ✓/✗ 成功/失败状态
- 找到/处理的项目数量
- 邮件列表预览（最多3封）
- 错误信息

### 自动刷新
当执行以下操作后，会自动刷新邮件列表：
- reply_email（回复）
- archive_email（归档）
- delete_email（删除）
- forward_email（转发）
- mark_read/mark_unread（标记）
- batch_archive/batch_delete（批量操作）
- compose_email（发送）

## 后端 API

### POST /api/chat

**请求**:
```json
{
  "message": "查看最近10封邮件",
  "email": "user@example.com"  // 可选，多账户时需要指定
}
```

**响应**:
```json
{
  "intent": "list_emails",
  "parameters": {
    "count": 10
  },
  "result": {
    "success": true,
    "count": 10,
    "data": [
      {
        "id": "123",
        "from": "sender@example.com",
        "subject": "邮件主题",
        "date": "2025-12-19"
      }
    ],
    "message": "找到 10 封邮件"
  },
  "message": "找到 10 封邮件"
}
```

## 测试步骤

### 1. 启动后端服务
```bash
cd f:\MyCode\mail_agent
python server.py
```

### 2. 启动前端服务
```bash
cd frontend
npm run dev
```

### 3. 登录账户
- 使用邮箱账户登录系统
- 确保 IMAP/SMTP 连接正常

### 4. 测试 AI 交互
在右侧 AI 面板输入框中尝试以下指令：

**基础查询**:
- "查看最近5封邮件"
- "显示未读邮件"

**搜索功能**:
- "搜索标题包含测试的邮件"
- "查找来自@163.com的邮件"

**邮件操作**:
- "总结第一封邮件"
- "标记第一封为已读"

**AI 辅助**:
- "分析邮件优先级"
- "总结最近的邮件内容"

## 快捷按钮

界面提供了3个快捷按钮：
1. "查看最近10封邮件" - 快速查看收件箱
2. "搜索账单邮件" - 查找财务相关邮件
3. "总结最近邮件" - AI 总结收件箱内容

## 错误处理

系统会自动处理以下错误：
- NLU 解析失败 - 显示"无法识别指令"
- 任务执行失败 - 显示具体错误信息
- 网络错误 - 显示"服务暂时不可用"
- 未登录 - 显示"请先登录"
- 多账户未指定 - 显示"请指定账户"

## 注意事项

1. **多账户场景**: 如果登录了多个邮箱账户，系统会自动使用当前活动账户
2. **性能优化**: 批量操作可能需要较长时间，请耐心等待
3. **数据刷新**: 某些操作会自动刷新邮件列表，无需手动刷新
4. **意图识别**: 尽量使用清晰明确的表述，避免歧义

## 技术架构

```
┌─────────────────┐
│  用户输入框     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  AssistantPanel │ (React 组件)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  sendMessage()  │ (App.tsx)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ POST /api/chat  │ (FastAPI)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  NLUEngine      │ (意图识别)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  TaskExecutor   │ (任务执行)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  EmailClient    │ (IMAP/SMTP)
└─────────────────┘
```

## 下一步优化建议

1. **添加语音输入**: 支持语音识别
2. **历史记录**: 保存对话历史
3. **快捷回复**: 预设常用指令
4. **多轮对话**: 支持上下文关联
5. **智能建议**: 根据邮箱状态主动建议操作
